import { ADVANCED_MODULE_OUTPUT_STRUCTURE } from "./advanced_module_output_structure";

/**
 * @description تعليمات موحّدة لمهمة التحليل النقدي المتقدم.
 * تهدف إلى توجيه الوكيل لتوليد تقرير تحليلي شامل ومتوافق مع بقية الوحدات.
 */
export const CORE_ANALYSIS_INSTRUCTIONS = `### مهمة التحليل النقدي المتقدم (TaskType.ANALYSIS)

#### الهدف
تقديم تشخيص سردي معمّق يوازن بين القياسات الكمية والاستنتاجات النوعية، مع إبراز أثر البنية والشخصيات والإيقاع على تجربة المشاهد.

#### نطاق المهمة وما لا يدخل في النطاق
- يشمل: تقييم المسودة أو السيناريو الكامل، قياس التوتر الدرامي، تحليل البنية السردية، تحديد نقاط القوة والضعف، وبلورة توصيات قابلة للتنفيذ.
- يشمل: مراجعة التوافق مع النوع (Genre) والجمهور، وقياس مدى انسجام الثيمات المركزية.
- لا يشمل: إعادة كتابة المشاهد بالكامل، أو إدخال شخصيات جديدة، أو إجراء تعديلات إنتاجية تفصيلية خارجة عن نطاق التحليل.

#### المدخلات المطلوبة بدقة (وحدات قياس، أنواع)
1. **ملف النص أو تفريغ موثّق**: بصيغة رقمية قابلة للبحث (PDF مع OCR، DOCX، نص عادي)، مع ترقيم صفحات واضح.
2. **بيانات العمل**: العنوان، الكاتب، المرحلة التطويرية، النوع، الطول (عدد الصفحات أو الدقائق)، تصنيف الجمهور المستهدف.
3. **ملاحظات أصحاب المصلحة**: أهداف التحسين، الملاحظات السابقة، القيود الزمنية أو الإنتاجية (بالساعات أو الميزانية التقديرية إن وجدت).
4. **مراجع مقارنة اختيارية**: أعمال مشابهة أو مراجع نوعية لدعم التقييم (نصوص أو روابط موثوقة).

#### المخرجات المتوقعة
- **نص تقريري منسق**: تقرير عربي مقسّم إلى فقرات معنونة (ملخص تنفيذي، تحليل البنية، تحليل الشخصيات، الإيقاع، التوصيات)، مع استخدام قوائم مرقمة عند عرض الإجراءات المقترحة.
- **مخرجات JSON مطابقة تماماً لـ \`AdvancedScreenplayModuleResult\`**:
${ADVANCED_MODULE_OUTPUT_STRUCTURE}
**الحقول الخاصة بقسم \`details\` لهذه الوحدة:**
\`\`\`json
{
  "storyStructureAudit": {
    "acts": [
      {
        "act": 1,
        "pages": { "start": 1, "end": 30 },
        "turningPoint": "حدث القفل الأول الذي يعيد توجيه الهدف الدرامي",
        "pacingScore": 0.68,
        "notes": "الإعداد واضح لكن الحافز الرئيسي يتأخر خمس صفحات."
      }
    ],
    "tensionCurve": [
      { "milestone": "المشهد الافتتاحي", "intensity": 0.42 },
      { "milestone": "ذروة الفصل الثاني", "intensity": 0.91 }
    ],
    "structuralRisks": [
      {
        "id": "risk_midpoint_lag",
        "description": "تباطؤ واضح قبل المشهد الأوسط",
        "severity": "medium",
        "mitigation": "تقديم مواجهة مبكرة تكسر حالة الركود."
      }
    ]
  },
  "characterImpactReview": {
    "spotlightCharacters": [
      {
        "name": "ليان",
        "dramaticFunction": "بطلة",
        "goalClarity": 0.8,
        "empathyDriver": "تسعى لإنقاذ شقيقها رغم المخاطر",
        "notes": "تحتاج لحظة ضعف تكشف ثمن التضحية في منتصف الفصل الثاني."
      }
    ],
    "antagonisticPressure": {
      "source": "شركة أمنية خاصة",
      "presenceScore": 0.74,
      "keyMoments": ["ملاحقة في الميناء", "تهديد العائلة في الصفحة 67"]
    }
  },
  "thematicAlignmentTracker": {
    "coreThemes": [
      {
        "theme": "الحرية مقابل الأمان",
        "deliveryScore": 0.71,
        "evidence": ["مونولوج ليان في الصفحة 54", "المشهد الختامي"]
      }
    ],
    "consistencyNotes": "الثيمة الرئيسية متماسكة لكن تحتاج صورة ختامية أوضح."
  }
}
\`\`\`

#### معايير الجودة والتقييم
- **الدقة التحليلية**: ربط كل استنتاج بدليل صريح (مشهد، سطر، أو مؤشر زمني) وتسجيل مستوى الثقة (0-1).
- **التوازن بين الكم والكيف**: دمج المقاييس الرقمية مع تفسير سردي واضح لتأثيرها على تجربة الجمهور.
- **الوضوح السردي**: لغة فصحى مباشرة، وفقرات قصيرة تبرز النقاط المحورية.
- **قابلية التنفيذ**: كل توصية مرفقة بجهة مسؤولة، أثر متوقع، وقياس نجاح.
- **الاتساق مع البيانات**: التأكد من أن الدرجات والمخططات الزمنية متوافقة مع طول العمل.

#### خطوات التنفيذ خطوة بخطوة
1. استيعاب السياق العام وملخص العمل، وتثبيت بيانات التعريف في حقل \`metadata\`.
2. قراءة العمل قراءة سريعة لتحديد العُقد الدرامية، ثم إعادة القراءة مع تدوين الملاحظات المشهدية.
3. بناء مخطط توتر مبدئي وتحديثه أثناء التحليل للتأكد من دقة النقاط المحورية.
4. تقييم الشخصيات الرئيسية ضد أهدافها، دوافعها، والضغوط الخارجية، وتعبئة قسم \`characterImpactReview\`.
5. تحليل الثيمات المركزية وربطها بالأدلة النصية، وتوثيق المخاطر البنيوية في \`storyStructureAudit.structuralRisks\`.
6. صياغة التقرير النصي المنسق، ثم إنشاء كائن \`AdvancedScreenplayModuleResult\` متكامل مع التوصيات وخطة الخطوات التالية.
7. مراجعة نهائية للتأكد من خلو التقرير من التكرار، ومن التناسق بين النص والـJSON.

#### حالات الحافة والأخطاء الشائعة وكيفية التعامل معها
- **نصوص غير مكتملة أو مسودات قصيرة**: استخدم التقديرات بالاعتماد على المشاهد المتاحة مع توثيق مستوى الثقة المنخفض.
- **غياب بيانات الجمهور**: ضع افتراضًا محسوبًا بناءً على النوع وتاريخ العمل، ودوّن ذلك في \`metadata.notes\`.
- **تعارض الملاحظات مع البيانات**: أعط الأولوية للأدلة النصية، واذكر التباين بوضوح مع اقتراح تحقق إضافي.
- **مقاييس خارج النطاق (أكثر من 1 أو أقل من 0)**: صحح القيمة ووضح في الملاحظات أن البيانات الأصلية كانت غير صالحة.

#### مثال كامل قبل/بعد + مثال JSON فعلي وواقعي
**مقتطف من النص قبل التحليل:**
> "ليان تهرب عبر الميناء بينما تنطفئ الأضواء واحدًا تلو الآخر، ولا تزال ترفض الاتصال بوالدتها رغم الخطر." (صفحة 42)

**فقرة من التقرير بعد التحليل:**
> "يتصاعد التوتر في الميناء بفضل تتابع الإضاءة المتناقص، لكن غياب إشارة إلى ثمن عزلة ليان العاطفية يضعف التعاطف في هذا المقطع. يوصى بإضافة لحظة اتصال مقطوع تبرز صراعها الداخلي."

**عينة JSON متكاملة:**
\`\`\`json
{
  "title": "تقرير التحليل النقدي حول \"ظلال الميناء\"",
  "summary": "يبرز التحليل اتساق الثيمة الرئيسية (الحرية مقابل الأمان) مع الحاجة إلى تسريع التحفيز في الربع الأول وتدعيم الضغوط المضادة.",
  "metadata": {
    "workId": "wrk_shadowharbor_2025",
    "workTitle": "ظلال الميناء",
    "workFormat": "feature_film",
    "genres": ["thriller", "drama"],
    "primaryAudience": "adults",
    "secondaryAudiences": ["young_adults"],
    "developmentStage": "draft_two",
    "priority": "high",
    "categories": ["story_structure", "analysis"],
    "language": "ar",
    "locale": "ar-EG",
    "analyst": "AI Script Analyst",
    "collaborators": ["Script Supervisor"],
    "createdAt": "2025-03-01T09:00:00Z",
    "updatedAt": "2025-03-01T11:45:00Z",
    "analysisWindow": {
      "start": "2025-02-27T08:00:00Z",
      "end": "2025-03-01T08:00:00Z"
    },
    "wordCount": 19800,
    "runtimeMinutes": 112,
    "logline": "مهندسة نظم تكتشف تورط شركة الأمن في تهجير قسري فتخاطر بعائلتها لكشف الحقيقة.",
    "referenceWorks": ["Sicario (2015)", "Zero Dark Thirty (2012)"],
    "productionCompany": "Horizon Pictures",
    "notes": ["تمت مراجعة نسخة PDF موقعة بتاريخ 2025-02-18."]
  },
  "details": [
    {
      "id": "structure_diagnosis_01",
      "title": "تقييم البنية",
      "focus": "structure",
      "expositionMethod": "narration",
      "summary": "يكشف التحليل عن افتتاح جذاب يتأخر فيه التحفيز الخارجي مما يؤدي إلى انخفاض مؤقت في التوتر.",
      "personas": [],
      "insights": [],
      "beats": [],
      "conflicts": [],
      "relationships": [],
      "metrics": [],
      "storyStructureAudit": {
        "acts": [
          {
            "act": 1,
            "pages": { "start": 1, "end": 30 },
            "turningPoint": "اختفاء شقيق ليان عند نهاية المطاردة الأولى",
            "pacingScore": 0.65,
            "notes": "التمهيد طويل نسبيًا ويحتاج إلى تسريع تقديم الخطر الرئيسي."
          },
          {
            "act": 2,
            "pages": { "start": 31, "end": 90 },
            "turningPoint": "كشف شريك الشركة داخل فريق ليان",
            "pacingScore": 0.78,
            "notes": "تصاعد مستمر مع تباطؤ طفيف قبل منتصف الفصل."
          }
        ],
        "tensionCurve": [
          { "milestone": "افتتاحية الميناء", "intensity": 0.45 },
          { "milestone": "ذروة المواجهة في المخزن", "intensity": 0.93 },
          { "milestone": "الخاتمة", "intensity": 0.71 }
        ],
        "structuralRisks": [
          {
            "id": "risk_midpoint_lag",
            "description": "التباطؤ قبل المواجهة مع العميل المزدوج",
            "severity": "medium",
            "mitigation": "إدراج تسريب أمني يرفع الضغط قبل الصفحة 60."
          }
        ]
      },
      "characterImpactReview": {
        "spotlightCharacters": [
          {
            "name": "ليان",
            "dramaticFunction": "بطلة",
            "goalClarity": 0.8,
            "empathyDriver": "تحاول تحرير شقيقها من قبضة الشركة",
            "notes": "تحتاج لحظة ضعف عاطفي قبل مواجهة الضابط شريف."
          }
        ],
        "antagonisticPressure": {
          "source": "ضابط الأمن شريف",
          "presenceScore": 0.72,
          "keyMoments": ["تهديد العائلة في الصفحة 48", "المطاردة في المخزن"]
        }
      },
      "thematicAlignmentTracker": {
        "coreThemes": [
          {
            "theme": "الحرية مقابل الأمان",
            "deliveryScore": 0.74,
            "evidence": ["مونولوج ليان في الصفحة 54", "الخاتمة التي تبرز ثمن الحقيقة"]
          }
        ],
        "consistencyNotes": "الرمزية التقنية في الفصل الأخير تحتاج توضيح بصري."
      }
    }
  ],
  "recommendations": [
    {
      "id": "rec_accelerate_inciting",
      "title": "تسريع التحفيز",
      "description": "إعادة ترتيب المشاهد الأولى لإبراز اختفاء شقيق ليان خلال أول عشر صفحات.",
      "priority": "high",
      "category": "structure",
      "focus": "structure",
      "estimatedEffortHours": 8,
      "owner": "Lead Writer",
      "impact": "رفع التوتر المبكر وتحسين ارتباط الجمهور",
      "dependencies": [],
      "successCriteria": [
        "يظهر الحدث المحفز قبل الصفحة 12",
        "يحافظ على المنطق الزمني للمطاردة الافتتاحية"
      ]
    }
  ],
  "quality_metrics": {
    "narrativeCohesion": 78,
    "characterDepth": 82,
    "dialogueAuthenticity": 75,
    "pacingControl": 70,
    "thematicResonance": 80,
    "originality": 74,
    "productionFeasibility": 68,
    "audienceAlignment": 77,
    "localizationReadiness": 72,
    "confidenceInterval": {
      "lowerBound": 70,
      "upperBound": 85
    },
    "qualitativeNotes": [
      "توزيع التوتر يحتاج إلى ذروة مضادة قصيرة قبل الخاتمة.",
      "الحوار بين ليان وشريف قوي مع فرصة لإبراز دافع شريف الأخلاقي."
    ]
  },
  "next_steps": {
    "immediate": [
      {
        "id": "analysis_followup_outline",
        "description": "تطوير مخطط مشاهد معدل للفصل الأول",
        "owner": "Lead Writer",
        "dueDate": "2025-03-05T10:00:00Z",
        "priority": "high",
        "status": "planned",
        "successCriteria": [
          "إقرار المنتج التنفيذي على التعديل",
          "دمج مشهد تسريب أمني جديد"
        ]
      }
    ],
    "upcoming": [
      {
        "id": "analysis_readthrough",
        "description": "جلسة قراءة لتجربة المشاهد المعدلة",
        "owner": "Story Editor",
        "dueDate": "2025-03-12T14:00:00Z",
        "priority": "medium",
        "status": "planned",
        "successCriteria": [
          "جمع تغذية راجعة من ثلاثة ممثلين",
          "تحديد مدى تحسن التوتر في الصفحات الأولى"
        ]
      }
    ],
    "reviewSchedule": [
      {
        "milestone": "مراجعة نسخة التحفيز",
        "date": "2025-03-18T09:00:00Z",
        "focus": "structure",
        "notes": "تأكيد إدراج المشهد الجديد وتحديث التوتر."
      }
    ],
    "communicationPlan": {
      "stakeholders": [
        {
          "name": "مدير التطوير",
          "role": "Head of Story",
          "channel": "Slack",
          "cadence": "مرتين أسبوعيًا"
        }
      ],
      "notes": "يتم إرسال ملخص التحليل قبل 24 ساعة من كل اجتماع."
    }
  }
}
\`\`\`

#### متطلبات التوافق مع بقية الوحدات (تكامل integrated)
- تأكد من أن الهوية المعرّفة في \`metadata.workId\` تستخدم لاحقًا من قبل الوحدات المتخصصة (الشخصيات، الإيقاع، إلخ).
- يجب أن تتوافق الدرجات والتوصيات مع ما تنتجه الوحدات الفرعية؛ أي تعارض يجب توثيقه في \`metadata.notes\` مع اقتراح جلسة مواءمة.
- استخدم نفس تصنيفات \`categories\` و\`focus\` لضمان إمكانية الدمج التلقائي في لوحة القيادة المشتركة.
`;
